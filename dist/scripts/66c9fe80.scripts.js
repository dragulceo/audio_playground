"use strict";angular.module("audioApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("audioApp").controller("MainCtrl",["$scope","audio","effect","recorder","pitchShifter",function(a,b,c,d,e){function f(a,b){var d=Array.prototype.slice.call(arguments,2),e=i[a];b?e&&(g.removeNode(e),i[a]=null):e?e.updateParams.apply(e,d):(d.splice(0,0,a,g.getAudioContext()),e=i[a]=c.getEffectWithName.apply(c,d),g.addProcessingNode(e))}var g=b.newAudio(),h=[],i={};a.hasOriginalBuffer=!1,a.gain=1,a.reverbSeconds=0,a.reverbDecay=0,a.reverbReverse=0,a.delay=0,a.wave=0,a.filterType=0,a.filterFreq=0,a.filterQ=0,a.pitchShiftValue=1.6,a.pitchShiftProgress=0,a.recording=!1,a.hasPlayable=!1,a.pitchShifting=!1,a.pitchShifted=!1,a.playing=!1,a.micAnalyser={instance:!1},a.playAnalyser={instance:!1},g.setOnEndedHandler(function(){a.playing=!1,a.$apply()}),a.onReverbChange=function(){var b=!1;0===parseFloat(a.reverbSeconds)&&0===parseFloat(a.reverbDecay)&&(b=!0),f(c.list.REVERB,b,a.reverbSeconds,a.reverbDecay,a.reverbReverse)},a.onDelayChange=function(){f(c.list.DELAY,0===parseFloat(a.delay),a.delay)},a.onWaveChange=function(){f(c.list.WAVE,0===parseFloat(a.wave),a.wave)},a.onFilterChange=function(){var b=!1;0===parseFloat(a.filterFreq)&&0===parseFloat(a.filterFreq)&&(b=!0),f(c.list.FILTER,b,a.filterType,a.filterFreq,a.filterFreq)},a.onGainChange=function(){f(c.list.GAIN,parseFloat(a.gain)>=1,a.gain)},a.onLoopChange=function(){g.setLoop(a.loop)},a.onPitchClick=function(){a.pitchActive&&g.doPitch()},a.onStartRecordButtonClick=function(){a.onStopButtonClick(),a.hasPlayable=!1,a.micAnalyser.instance=d.getCurrentAudioManager().getAnalyser(),d.startRecording(),a.recording=!0},a.setPlayable=function(){g.startOutput(),a.hasPlayable=!0,a.$$phase||a.$apply()},a.setBufferToPlay=function(b){g.setBufferSource(b),a.setPlayable()},a.onStopRecordButtonClick=function(){d.stopRecording(a.setBufferToPlay),a.recording=!1,a.micAnalyser.instance=!1},a.onLoadTestData=function(){a.onStopButtonClick(),g.setURLInput("./assets/itsmylife.mp3",a.setPlayable),a.pitchShifted=!1},a.onLoadFile=function(){var b,c=document.querySelector("#loadFilename").files;c.length>0&&(b=new FileReader,b.onload=function(b){g.setRawLoadedData(b.currentTarget.result,function(){a.setPlayable()})},b.readAsArrayBuffer(c[0]))},a.onStartButtonClick=function(){a.playAnalyser.instance=g.getAnalyser(),g.play(a.loop),a.playing=!0},a.onStopButtonClick=function(){g.stop(),a.playing=!1,a.playAnalyser.instance=!1},a.onPitchShiftButtonClick=function(){a.onStopButtonClick(),g.hasSource()&&(h.push([g.getSource().buffer.getChannelData(0),g.getSource().buffer.getChannelData(1)]),a.hasOriginalBuffer=!0,e.addEventListener(a),a.$on(e.events.PITCH_SHIFTER_PROGRESS,a.updatePitchShiftProgressBar),a.$on(e.events.PITCH_SHIFTER_ENDED,a.setPitchShiftedBufferToPlay),e.createPitchShiftedBuffer(g.getSource(),a.pitchShiftValue))},a.onUndoPitchButtonClick=function(){h.length>0&&(a.onStopButtonClick(),g.setFloat32ArrayBuffers(h.pop()),a.hasOriginalBuffer=h.length,a.setPlayable())},a.updatePitchShiftProgressBar=function(b,c){var d=c.progress/100;d>0&&1>d?a.pitchShifting=!0:(a.pitchShifting=!1,1===d&&(a.pitchShifted=!0)),a.pitchShiftProgress=d,a.$apply()},a.setPitchShiftedBufferToPlay=function(b,c){e.removeEventListener(a),g.setFloat32ArrayBuffers(c.data),a.setPlayable()},a.onDownloadButtonClick=function(){g.save()}}]),angular.module("audioApp").factory("audio",function(){function a(){var a=window.AudioContext||window.webkitAudioContext,b=new a;return!b.createJavaScriptNode&&b.createScriptProcessor&&(b.createJavaScriptNode=b.createScriptProcessor),b}function b(){this.nodes=[],this.source=null,this.analyser=null,this.output=null,this.playing=!1,this.onended=d}var c=null,d=function(){};return angular.extend(b.prototype,{getAudioContext:function(){return this.audioContext||(this.audioContext=a()),this.audioContext},setSource:function(a){var b=null;this.nodes.length>0?b=this.nodes[0]:this.hasOutput()&&(b=this.getOutput()),b&&a.connect(b),this.source=a},getSource:function(){return this.source},hasSource:function(){return null!==this.source},setOutput:function(a){var b=this.getLastNode();a!==this.output&&(b||(b=this.getSource()),b&&(null===a?b.disconnect():b.connect(a)),this.output=a)},getOutput:function(){return this.output},hasOutput:function(){return null!==this.output},stopOutput:function(){this.setOutput(null)},startOutput:function(){this.setOutput(this.getAudioContext().destination)},insertNodeAtIndex:function(a,b){var c,d;if(!(this.nodes.length>=b&&b>=0))throw new Error("Invalid index. Can't insert at "+b+" position.");b>0?c=this.nodes[b-1]:this.hasSource()&&(c=this.getSource()),b<this.nodes.length?d=this.nodes[b]:this.getOutput()&&(d=this.getOutput()),c&&(c.disconnect(),c.connect(a)),d&&a.connect(d),this.nodes.splice(b,0,a)},removeNode:function(a){var b,c=this.nodes.length;for(b=0;c>b;b++)if(this.nodes[b]===a){a.disconnect(),1===c?this.hasSource()&&(this.getSource().disconnect(),this.hasOutput()&&this.getSource().connect(this.getOutput())):0===b?(this.getSource().disconnect(),this.getSource().connect(this.nodes[1])):b===c-1?(this.nodes[c-2].disconnect(),this.hasOutput()&&this.nodes[c-2].connect(this.getOutput())):(this.nodes[b-1].disconnect(),this.nodes[b-1].connect(this.nodes[b+1])),this.nodes.splice(b,1);break}},pushNode:function(a){this.insertNodeAtIndex(a,this.nodes.length)},addProcessingNode:function(a){this.insertNodeAtIndex(a,0)},getLastNode:function(){return this.nodes[this.nodes.length-1]},createAnalyser:function(){var a;return a=this.getAudioContext().createAnalyser(),a.fftSize=512,a},getAnalyser:function(){return this.analyser||(this.analyser=this.createAnalyser(),this.pushNode(this.analyser)),this.analyser},setOnEndedHandler:function(a){this.playing=!1,angular.isFunction(a)&&(this.onended=a)},setSourceFromInputStream:function(a,b){this.setSource(this.getAudioContext().createMediaStreamSource(a)),angular.isFunction(b)&&b()},setUserMediaInput:function(a){var b,d=this;c?this.setSourceFromInputStream(c,a):(b=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,b.call(navigator,{audio:!0},function(b){c=b,d.setSourceFromInputStream(b,a)},function(){"console"in window&&console.error(arguments)}))},setBufferSource:function(a){var b=this.getAudioContext(),c=b.createBufferSource();return c.buffer=a,c.playbackRate.value=1,c.onended=this.onended,this.setSource(c),c},setRawLoadedData:function(a,b){var c=this;this.getAudioContext().decodeAudioData(a,function(a){c.setBufferSource(a),angular.isFunction(b)&&b()})},setURLInput:function(a,b){var c=new XMLHttpRequest,d=this;c.open("GET",a,!0),c.responseType="arraybuffer",c.onload=function(){d.setRawLoadedData(c.response,b)},c.send()},setFloat32ArrayBuffers:function(a){var b,c;if(angular.isArray(a)&&(b=a.length,b>0)){for(c=this.getAudioContext().createBuffer(b,a[0].length,44100);b--;)c.getChannelData(b).set(a[b]);this.setBufferSource(c)}},setLoop:function(a){this.hasSource()&&(this.getSource().loop=a)},setState:function(a,b){var c,d;if(this.hasSource()){if("start"===a)this.playing=!0,d=this.getSource().buffer,c=d?this.setBufferSource(this.getSource().buffer):this.getSource(),this.startOutput();else{if(!this.playing)return;this.playing=!1,c=this.getSource()}c.curentTime=0,c.loop=b,a in c?c[a](0):"start"===a?c.noteOn(0):c.noteOff(0)}},play:function(a){this.setState("start",a)},stop:function(){this.setState("stop")},forceDownload:function(a,b){var c=(window.URL||window.webkitURL).createObjectURL(a),d=window.document.createElement("a");d.href=c,d.download=b||"output.wav";var e=document.createEvent("Event");e.initEvent("click",!0,!0),d.dispatchEvent(e)},save:function(){var a,b=this;a=new Worker("scripts/workers/export.js"),a.postMessage({type:"audio/wav",bufferL:this.getSource().buffer.getChannelData(0),bufferR:this.getSource().buffer.getChannelData(1),sampleRate:this.getAudioContext().sampleRate}),a.addEventListener("message",function(a){b.forceDownload(a.data)},!1)}}),{newAudio:function(){return new b}}}),angular.module("audioApp").factory("effect",[function(){function a(a){var b=Array.prototype.slice.call(arguments,1);return c[a].apply(null,b)}var b,c={},d={REVERB:"reverb",WAVE:"wave",DELAY:"delay",FILTER:"filter",GAIN:"gain",BUFFER:"buffer",PITCH:"pitch"};return b=function(a,b,c,d){var e,f,g,h,i,j,k=a.sampleRate;for(e=k*b||1,f=a.createBuffer(2,e,k),g=f.getChannelData(0),h=f.getChannelData(1),j=0;e>j;j++)i=d?e-j:j,g[j]=(2*Math.random()-1)*Math.pow(1-i/e,c),h[j]=g[j];return f},c[d.REVERB]=function(a,c,d,e){var f=a.createConvolver();return f._context=a,f.updateParams=f.setSecondsAndDecay=function(a,c,d){f.buffer=b(this._context,a,c,d)},f.setSecondsAndDecay(c,d,e),f},c[d.WAVE]=function(a,b){var c=a.createWaveShaper(),d=2048,e=new Float32Array(d);return c.updateParams=c.setCurve=function(a){if(a>=0&&1>a){var b,f,g=2*a/(1-a);for(f=0;d>f;f+=1)b=2*(f-0)/(d-0)+-1,e[f]=(1+g)*b/(1+g*Math.abs(b))}c.curve=e},c.setCurve(b),c},c[d.DELAY]=function(a,b){var c;return"createDelayNode"in a?c=a.createDelayNode():"createDelay"in a&&(c=a.createDelay()),c.updateParams=c.setDelay=function(a){c.delayTime.value=parseFloat(a)},c.setDelay(b),c},c[d.FILTER]=function(a,b,c,d){var e,f,g,h;return e=a.createBiquadFilter(),f=40,g=a.sampleRate/2,h=Math.log(g/f)/Math.LN2,e.updateParams=e.setFilterWithTypeFrequencyAndQ=function(a,b,c){e.type=parseInt(a,10),e.frequency.value=g*Math.pow(2,h*(b-1)),e.Q.value=c},e.setFilterWithTypeFrequencyAndQ(b,c,d),e},c[d.GAIN]=function(a,b){var c;return"createGainNode"in a?c=a.createGainNode():"createGain"in a&&(c=a.createGain()),c.updateParams=c.setGain=function(a){c.gain.value=parseFloat(a)},c.setGain(b),c},c[d.BUFFER]=function(a){var b=a.createBufferSource();return b.noteOn(0),b},{getReverb:function(b,c,e){return a(d.REVERB,b,c,e)},getWave:function(b,c){return a(d.WAVE,b,c)},getDelay:function(b,c){return a(d.DELAY,b,c)},getFilter:function(b,c,e){return a(d.FILTER,b,c,e)},getGain:function(b,c){return a(d.GAIN,b,c)},getPitch:function(b){return a(d.PITCH,b)},list:d,getEffectWithName:a}}]),function(a){var b=function(){function a(){var a=g;for(k[2*a]=0,l[2*a]=0,j[2*a-1]=0,m[2*a-1]=0;a--;)h[a]=i[a]=j[a]=j[2*a]=k[a]=k[2*a]=l[a]=l[2*a]=m[a]=m[2*a]=n[a]=o[a]=p[a]=q[a]=0}function b(a){return a>0?Math.floor(a):Math.ceil(a)}function c(a,b,c,e){return d(a,b,2048,10,c,e)}function d(c,d,f,g,t,u){var v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L=0;a();var M=u;for(J=b(f/2),I=b(f/g),B=t/f,C=2*Math.PI*I/f,H=b(f-I),0===r&&(r=H),D=0;d>D;D++)if(K=Math.floor(D/d*100),K!==L&&(L=K,s(K)),h[r]=u[D],M[D]=i[r-H],r++,r>=f){for(r=H,E=0;f>E;E++)y=-.5*Math.cos(2*Math.PI*E/f)+.5,j[2*E]=h[E]*y,j[2*E+1]=0;for(e(j,f,-1),E=0;J>=E;E++)z=j[2*E],A=j[2*E+1],v=2*Math.sqrt(z*z+A*A),w=Math.atan2(A,z),x=w-k[E],k[E]=w,x-=E*C,F=b(x/Math.PI),F>=0?F+=1&F:F-=1&F,x-=Math.PI*F,F=b(F),x=g*x/(2*Math.PI),x=E*B+x*B,o[E]=v,n[E]=x;for(var N=0;f>N;N++)q[N]=0,p[N]=0;for(E=0;J>=E;E++)G=b(E*c),J>=G&&(q[G]+=o[E],p[G]=n[E]*c);for(E=0;J>=E;E++)v=q[E],x=p[E],x-=E*B,x/=B,x=2*Math.PI*x/g,x+=E*C,l[E]+=x,w=l[E],j[2*E]=v*Math.cos(w),j[2*E+1]=v*Math.sin(w);for(E=f+2;2*f>E;E++)j[E]=0;for(e(j,f,1),E=0;f>E;E++)y=-.5*Math.cos(2*Math.PI*E/f)+.5,m[E]+=2*y*j[2*E]/(J*g);for(E=0;I>E;E++)i[E]=m[E];for(E=0;f>E;E++)m[E]=m[E+I];for(E=0;H>E;E++)h[E]=h[E+I]}return M}function e(a,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(m=2;2*c-2>m;m+=2){for(n=2,o=0;2*c>n;n<<=1)0!==(m&n)&&o++,o<<=1;o>m&&(h=a[m],a[m]=a[o],a[o]=h,h=a[m+1],a[m+1]=a[o+1],a[o+1]=h)}for(s=b(Math.log(c)/Math.log(2)+.5),r=0,p=2;s>r;r++)for(p<<=1,q=p>>1,g=Math.PI/(q>>1),k=1,l=0,e=Math.cos(g),f=d*Math.sin(g),o=0;q>o;o+=2){for(m=o;2*c>m;m+=p)i=a[m+q]*k-a[m+q+1]*l,j=a[m+q]*l+a[m+q+1]*k,a[m+q]=a[m]-i,a[m+q+1]=a[m+1]-j,a[m]+=i,a[m+1]+=j;i=k*e-l*f,l=k*f+l*e,k=i}}function f(a){s=a}var g=16e3,h=new Float32Array(g),i=new Float32Array(g),j=new Float32Array(2*g),k=new Float32Array(g/2+1),l=new Float32Array(g/2+1),m=new Float32Array(2*g),n=new Float32Array(g),o=new Float32Array(g),p=new Float32Array(g),q=new Float32Array(g),r=0,s=function(){};return{pitchShift:c,pitchShiftEx:d,setProgressCallback:f}}();if(a&&"angular"in a&&angular.module("audioApp").factory("pitchShift",function(){return b}),a&&"self"in a&&a.self.addEventListener){var c,d={},e=a.self,f=2;c=function(){0===f&&(b.setProgressCallback(function(a){e.postMessage({progress:a})}),b.pitchShiftEx(parseFloat(d.pitch),d.buffer.length,parseInt(d.frameSize,10),parseInt(d.osamp,10),parseInt(d.sampleRate,19),d.buffer),e.postMessage(d.buffer.buffer))},e.addEventListener("message",function(a){for(var b,e=a.data,g=["pitch","frameSize","osamp","sampleRate"],h=g.length;h--;)g[h]in e&&(b=!0,d[g[h]]=e[g[h]]);b?f--:(d.buffer=new Float32Array(e),f--),c()},!1)}}(this),angular.module("audioApp").service("recorder",["audio",function(a){function b(a,b){return new window.Recorder(a,angular.extend({workerPath:"./bower_components/Recorderjs/recorderWorker.js"},b||{}))}function c(){f&&(f.stop(),f=null),g.setUserMediaInput(function(){f=b(g.getLastNode()),f.record()})}function d(a){f&&(f.stop(),f.getBuffer(function(b){var c=g.getAudioContext(),d=c.createBuffer(2,b[0].length,c.sampleRate);d.getChannelData(0).set(b[0]),d.getChannelData(1).set(b[1]),angular.isFunction(a)&&a(d)}))}function e(){return g}var f,g=a.newAudio();return{startRecording:c,stopRecording:d,getCurrentAudioManager:e}}]),angular.module("audioApp").directive("canvasVisualiser",function(){return{template:"<canvas></canvas>",restrict:"E",scope:{analyser:"=?analyserInstance"},link:function(a,b){function c(a,b){g=a,h=b,e.clearRect(0,0,g,h),e.fillStyle="rgba("+parseInt(255*Math.random(),10)+","+parseInt(255*Math.random(),10)+","+parseInt(255*Math.random(),10)+",1)"}function d(){var b,c,f=[1];if(e&&(e.clearRect(0,0,g,h),a.analyser&&a.analyser.instance))for(i=a.analyser.instance,b=i.frequencyBinCount,f=new Uint8Array(b),i.getByteFrequencyData(f);b--;)c=f[b]/3,e.fillRect(2*b,h-c,1,c);j&&window.requestAnimationFrame(d)}var e,f,g,h,i,j;a.$watch("analyser.instance",function(a){a?(j=!0,window.requestAnimationFrame(d)):j=!1}),f=b[0].firstChild,e=f.getContext("2d"),c(f.width,f.height)}}}),angular.module("audioApp").service("pitchShifter",["pitchShift",function(a){function b(a){for(var b=a.length,c=0;b--;)c+=a[b];return c/a.length}function c(){i(o.PITCH_SHIFTER_ENDED,{data:l})}function d(a,d){var e;m[d]=a,e=b(m),i(o.PITCH_SHIFTER_PROGRESS,{progress:e}),e>=100&&c()}function e(a,b){d(b,a)}function f(a,b){l[a]=b,d(100,a)}function g(b,c){var d,g,h,j,k,l=[],m=!0;if(c=c||2,h={frameSize:2048,sampleRate:b.context.sampleRate,osamp:4,pitch:c},b&&"buffer"in b)if(g=b.buffer,j=function(a){return function(b){"debug"in b.data||("progress"in b.data?e(a,b.data.progress):f(a,new Float32Array(b.data)))}},d=[g.getChannelData(0),g.getChannelData(1)],m)for(k=d.length;k--;)l[k]=new Worker("scripts/services/pitch_shift.js"),l[k].addEventListener("message",j(k),!1),l[k].postMessage(h),l[k].postMessage(d[k].buffer);else i(o.PITCH_SHIFTER_ENDED,{buffer0:a.pitchShiftEx(h.pitch,d[0].length,h.frameSize,h.osamp,h.sampleRate,d[0]),buffer1:a.pitchShiftEx(h.pitch,d[1].length,h.frameSize,h.osamp,h.sampleRate,d[1])})}function h(a){n.push(a)}function i(a,b){for(var c=n.length;c--;)"$emit"in n[c]&&n[c].$emit(a,b)}function j(a){for(var b=n.length;b--;)n[b]===a&&n.splice(b,1)}function k(a){return l[a]}var l=[],m=[],n=[],o={PITCH_SHIFTER_STARTED:"onPitchShifterStarted",PITCH_SHIFTER_ENDED:"onPitchShifterEnded",PITCH_SHIFTER_PROGRESS:"onPitchShifterProgress"};return{events:o,addEventListener:h,removeEventListener:j,createPitchShiftedBuffer:g,getPitchShiftedBuffer:k}}]);